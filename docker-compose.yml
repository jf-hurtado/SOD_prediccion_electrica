services:
  # Contenedor para la base de datos MongoDB
  mongo:
    image: mongo:7.0
    container_name: mongo
    restart: unless-stopped
    ports:
      - "${HOST_MONGO_PORT}:27017" # Opcional: para acceder con Compass desde tu m√°quina
    volumes:
      - mongo-data:/data/db

  # --- BACKEND ---
  # Microservicio ACQUIRE
  acquire:
    build: ./backend/acquire
    container_name: acquire
    restart: unless-stopped
    depends_on:
      - mongo
    ports:
      - "${HOST_ACQUIRE_PORT}:3001"
    environment: # Sobreescribimos la variable MONGO_URI solo para este servicio
      - MONGO_URI=${MONGO_URI_BASE}/acquire_db
      - KUNNA_URL=${KUNNA_URL}
      - PORT=3001

  # Microservicio PREDICT
  predict:
    build: ./backend/predict
    container_name: predict
    restart: unless-stopped
    depends_on:
      - mongo
    ports:
      - "${HOST_PREDICT_PORT}:3002"
    environment: # Sobreescribimos la variable MONGO_URI solo para este servicio
      - MONGO_URI=${MONGO_URI_BASE}/predict_db
      - PORT=3002

  # Microservicio ORCHESTRATOR
  orchestrator:
    build: ./backend/orchestrator
    container_name: orchestrator
    restart: unless-stopped
    depends_on:
      - acquire
      - predict
    ports:
      - "${HOST_ORCHESTRATOR_PORT}:8080"
    environment:
      - ACQUIRE_SERVICE_URL=http://acquire:3001
      - PREDICT_SERVICE_URL=http://predict:3002
      - PORT=8080

  # --- FRONTEND ---
  frontend:
    build: ./frontend/v1-vanilla-nginx # "Usa la receta de la carpeta v1"
    container_name: frontend
    restart: unless-stopped
    ports:
      - "80:80" # Mapea el puerto 80 (HTTP) de tu PC al puerto 80 de Nginx 

# Volumen para persistir los datos de MongoDB
volumes:
  mongo-data: